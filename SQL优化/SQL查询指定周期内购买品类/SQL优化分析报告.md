# SQL查询优化分析报告

## 原SQL问题分析

### 1. 性能问题
- **重复数据扫描**：`aggregated_data` CTE被6个不同的子查询重复使用
- **多次GROUP BY操作**：相同的数据被重复分组聚合6次
- **复杂的JOIN链**：最终查询包含5个JOIN操作，增加了执行复杂度
- **内存使用过多**：多个中间结果集同时存在内存中

### 2. 代码维护问题
- **代码冗余**：大量重复的聚合逻辑
- **可读性差**：过多的CTE和JOIN使逻辑难以理解
- **维护困难**：修改聚合逻辑需要在多个地方同步更新

## 优化方案

### 方案1：基础优化版（推荐）
**文件**：`SQL查询指定周期内购买品类_最优版.sql`

**优化要点**：
- 将原来的8个CTE减少到1个
- 消除了5个JOIN操作
- 在单次GROUP BY中完成所有MAP_AGG操作
- 大幅减少了中间结果集

**性能提升**：
- 减少数据扫描次数：从6次减少到1次
- 减少内存使用：消除多个中间结果集
- 简化执行计划：从复杂的多表JOIN变为单表聚合

### 方案2：标准优化版
**文件**：`SQL查询指定周期内购买品类_优化版.sql`

**特点**：
- 保持了原有的逻辑结构
- 减少了CTE数量但保留了清晰的步骤
- 适合需要逐步验证结果的场景

### 方案3：高级优化版
**文件**：`SQL查询指定周期内购买品类_高级优化版.sql`

**特点**：
- 处理了MAP_AGG可能的重复键问题
- 使用COLLECT_SET和MAP_FROM_ARRAYS
- 适合数据质量不确定的场景

## 性能对比

| 指标 | 原SQL | 优化后 | 改善幅度 |
|------|-------|--------|----------|
| CTE数量 | 8个 | 1个 | -87.5% |
| JOIN操作 | 5个 | 0个 | -100% |
| 数据扫描次数 | 6次 | 1次 | -83.3% |
| 代码行数 | 111行 | 25行 | -77.5% |

## 推荐使用

**生产环境推荐**：使用最优版（`SQL查询指定周期内购买品类_最优版.sql`）
- 性能最佳
- 代码最简洁
- 维护成本最低

**注意事项**：
1. 如果数据中存在NULL值，需要在MAP_AGG中添加过滤条件
2. 如果需要处理重复的分类名称，考虑使用高级优化版
3. 建议在测试环境验证结果一致性后再部署到生产环境

## 额外优化建议

1. **索引优化**：确保在 `(customer_id, dt)` 上有合适的索引
2. **分区优化**：如果表按日期分区，确保查询能够利用分区裁剪
3. **统计信息**：保持表统计信息的及时更新
4. **并行度**：根据数据量调整查询的并行度设置
