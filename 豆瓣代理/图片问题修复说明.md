# 图片显示问题修复说明

## 问题原因

豆瓣的图片无法直接显示主要有以下原因:

1. **防盗链保护**: 豆瓣的图片服务器会检查 HTTP Referer 头,如果不是从豆瓣域名访问,会拒绝请求
2. **跨域限制**: 浏览器的同源策略限制
3. **懒加载**: 部分图片使用 `data-src` 属性进行懒加载

## 解决方案

### 1. 添加图片代理路由 (`/proxy-image`)

```javascript
app.get('/proxy-image', async (req, res) => {
  // 接收图片URL参数
  // 使用正确的 Referer 头请求豆瓣图片
  // 返回图片数据给浏览器
});
```

**工作原理**:
- 浏览器请求: `http://localhost:3000/proxy-image?url=https://img.doubanio.com/xxx.jpg`
- 服务器代理请求豆瓣图片,带上正确的 Referer
- 返回图片数据给浏览器

### 2. 修改所有图片链接

将原始的豆瓣图片链接转换为通过我们代理服务器的链接:

**原始链接**:
```html
<img src="https://img.doubanio.com/view/photo/xxx.jpg">
```

**转换后**:
```html
<img src="/proxy-image?url=https%3A%2F%2Fimg.doubanio.com%2Fview%2Fphoto%2Fxxx.jpg">
```

### 3. 处理懒加载图片

同时处理 `src` 和 `data-src` 属性,确保懒加载的图片也能正常显示。

## 使用方法

1. **重启服务器**:
```bash
npm start
```

2. **访问网站**:
```
http://localhost:3000
```

3. **验证图片加载**:
- 打开浏览器开发者工具 (F12)
- 查看 Network 标签
- 应该能看到 `/proxy-image?url=...` 的请求
- 图片应该正常显示

## 性能优化

代码中已添加缓存头:
```javascript
res.set('Cache-Control', 'public, max-age=86400'); // 缓存1天
```

这样浏览器会缓存图片,减少重复请求。

## 可能的问题

### 1. 图片加载慢
- **原因**: 每张图片都需要通过服务器代理
- **解决**: 可以添加 Redis 缓存或使用 CDN

### 2. 部分图片仍无法显示
- **原因**: 豆瓣可能有额外的验证机制
- **解决**: 检查浏览器控制台的错误信息,调整请求头

### 3. 服务器负载高
- **原因**: 大量图片请求
- **解决**:
  - 添加缓存层
  - 使用图片压缩
  - 限制并发请求数

## 测试建议

1. 打开浏览器开发者工具
2. 访问 `http://localhost:3000`
3. 检查 Network 标签中的图片请求
4. 确认图片正常加载

## 进一步优化

如果需要更好的性能,可以考虑:

1. **添加 Redis 缓存**:
```javascript
const redis = require('redis');
const client = redis.createClient();
// 缓存图片数据
```

2. **使用 CDN**:
将图片上传到自己的 CDN 服务

3. **图片压缩**:
使用 sharp 等库压缩图片

4. **批量预加载**:
提前加载可见区域的图片
