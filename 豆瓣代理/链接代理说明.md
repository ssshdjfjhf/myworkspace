# 链接代理功能说明

## 🎯 功能目标

确保用户在代理网站中点击任何豆瓣链接后,仍然保持在代理环境中,而不会跳转到豆瓣原站。

## 🔧 实现原理

### 1. 链接类型识别与处理

代码会自动识别并处理三种类型的链接:

#### ① 相对路径链接
```html
<!-- 原始 -->
<a href="/subject/35295232/">电影详情</a>

<!-- 处理后 -->
<a href="/subject/35295232/">电影详情</a>
<!-- 保持不变,浏览器会自动访问 localhost:3000/subject/35295232/ -->
```

#### ② 协议相对路径
```html
<!-- 原始 -->
<a href="//movie.douban.com/subject/123/">链接</a>

<!-- 处理后 -->
<a href="/subject/123/">链接</a>
<!-- 转换为相对路径,通过代理访问 -->
```

#### ③ 绝对路径
```html
<!-- 原始 - 豆瓣链接 -->
<a href="https://movie.douban.com/subject/123/">链接</a>

<!-- 处理后 -->
<a href="/subject/123/">链接</a>
<!-- 提取路径部分,通过代理访问 -->

<!-- 原始 - 外部链接 -->
<a href="https://www.google.com">Google</a>

<!-- 处理后 -->
<a href="https://www.google.com" target="_blank" rel="noopener noreferrer">Google</a>
<!-- 保持不变,但在新窗口打开 -->
```

## 📝 代码实现

### 核心逻辑

```javascript
$('a').each((i, elem) => {
  const href = $(elem).attr('href');
  if (!href) return;

  // 1. 相对路径 - 保持不变
  if (href.startsWith('/') && !href.startsWith('//')) {
    // 不需要修改
  }
  // 2. 协议相对路径
  else if (href.startsWith('//')) {
    const url = new URL('https:' + href);
    if (url.hostname.includes('douban.com')) {
      // 转换为相对路径
      $(elem).attr('href', url.pathname + url.search + url.hash);
    }
  }
  // 3. 绝对路径
  else if (href.startsWith('http')) {
    const url = new URL(href);
    if (url.hostname.includes('douban.com')) {
      // 豆瓣链接 -> 相对路径
      $(elem).attr('href', url.pathname + url.search + url.hash);
    } else {
      // 外部链接 -> 新窗口打开
      $(elem).attr('target', '_blank');
    }
  }
});
```

## 🌐 处理的元素

### 1. 超链接 (`<a>`)
所有豆瓣域名的链接都会被转换为相对路径

### 2. 表单 (`<form>`)
```javascript
$('form').each((i, elem) => {
  const action = $(elem).attr('action');
  // 将豆瓣域名的action转换为相对路径
});
```

### 3. Meta刷新标签
```javascript
$('meta[http-equiv="refresh"]').each((i, elem) => {
  // 处理自动跳转的meta标签
});
```

## 🎬 实际效果

### 场景1: 首页点击电影
```
用户操作: 在 localhost:3000 点击"绮梦之旅"
原始链接: https://movie.douban.com/subject/35295232/
转换后:   /subject/35295232/
实际访问: localhost:3000/subject/35295232/
✅ 保持在代理环境中
```

### 场景2: 详情页点击演员
```
用户操作: 点击"玛格特·罗比"
原始链接: https://movie.douban.com/celebrity/1054448/
转换后:   /celebrity/1054448/
实际访问: localhost:3000/celebrity/1054448/
✅ 保持在代理环境中
```

### 场景3: 点击外部链接
```
用户操作: 点击某个外部网站链接
原始链接: https://www.imdb.com/title/tt123/
处理后:   target="_blank" (新窗口打开)
✅ 不影响代理环境
```

## 🔍 支持的豆瓣域名

代码会识别所有包含 `douban.com` 的域名:
- `movie.douban.com` - 电影
- `book.douban.com` - 读书
- `music.douban.com` - 音乐
- `www.douban.com` - 主站
- 等等...

## 📊 链接转换示例

| 原始链接 | 转换后 | 说明 |
|---------|--------|------|
| `/subject/123/` | `/subject/123/` | 相对路径,不变 |
| `//movie.douban.com/subject/123/` | `/subject/123/` | 协议相对,转相对 |
| `https://movie.douban.com/subject/123/` | `/subject/123/` | 绝对路径,转相对 |
| `https://movie.douban.com/subject/123/?from=showing` | `/subject/123/?from=showing` | 保留查询参数 |
| `https://www.google.com` | `https://www.google.com` (新窗口) | 外部链接 |

## 🎯 优势

1. **无缝体验**: 用户感觉就像在使用一个完整的网站
2. **保持功能**: 所有自定义功能(下载按钮等)在所有页面都可用
3. **安全隔离**: 外部链接在新窗口打开,不影响代理环境
4. **完整路径**: 保留查询参数和hash,确保功能完整

## 🧪 测试方法

### 1. 测试首页链接
```bash
# 启动服务器
npm start

# 访问首页
http://localhost:3000

# 点击任意电影
# 观察地址栏: 应该是 localhost:3000/subject/xxx/
```

### 2. 测试详情页链接
```bash
# 访问详情页
http://localhost:3000/subject/35295232/

# 点击导演、演员等链接
# 观察地址栏: 应该保持 localhost:3000 域名
```

### 3. 测试外部链接
```bash
# 点击任何外部链接(如IMDb)
# 应该在新窗口打开
```

## 🐛 可能的问题

### 1. JavaScript动态生成的链接
**问题**: 页面中的JavaScript可能动态生成豆瓣链接
**解决**: 可以注入额外的JavaScript来拦截这些操作

### 2. AJAX请求
**问题**: 页面可能通过AJAX请求豆瓣API
**解决**: 需要代理AJAX请求或修改JavaScript

### 3. 登录跳转
**问题**: 登录页面可能跳转到豆瓣原站
**解决**: 需要特殊处理登录相关的链接

## 🚀 进阶优化

### 1. 添加链接拦截器
```javascript
// 在注入的JavaScript中添加
document.addEventListener('click', function(e) {
  const link = e.target.closest('a');
  if (link && link.href.includes('douban.com')) {
    e.preventDefault();
    const url = new URL(link.href);
    window.location.href = url.pathname + url.search + url.hash;
  }
});
```

### 2. 代理AJAX请求
```javascript
// 拦截fetch和XMLHttpRequest
const originalFetch = window.fetch;
window.fetch = function(url, options) {
  if (typeof url === 'string' && url.includes('douban.com')) {
    url = url.replace(/https?:\/\/[^\/]*douban\.com/, '');
  }
  return originalFetch(url, options);
};
```

## 📝 总结

通过智能识别和转换链接,我们实现了:
- ✅ 用户点击任何豆瓣链接都保持在代理环境中
- ✅ 外部链接正常工作(新窗口打开)
- ✅ 保留完整的URL参数和功能
- ✅ 无缝的用户体验

现在你的代理网站就像一个完整的独立网站一样工作! 🎉
